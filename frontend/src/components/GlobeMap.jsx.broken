import React, { useEffect, useState, useRef, useImperativeHandle, forwardRef } from 'react'
import Globe from 'react-globe.gl'
import TrackList from './TrackList'

const GlobeMap = forwardRef(({ countries, playlists, selectedPlaylist, trackFilter, currentTrack, onPlaySong, onSelectPlaylist, onRemovePlaylist }, ref) => {
  const globeEl = useRef()
  const [selectedCountry, setSelectedCountry] = useState(null)
  const [isInteracting, setIsInteracting] = useState(false)
  const [showCountryList, setShowCountryList] = useState(true)
  const [showPlaylistsSection, setShowPlaylistsSection] = useState(true)
  const [countrySearchTerm, setCountrySearchTerm] = useState('')
  const [playlistSearchTerm, setPlaylistSearchTerm] = useState('')
  const [trackSearchTerm, setTrackSearchTerm] = useState('')
  const interactionTimeout = useRef(null)
  const selectedCountryRef = useRef(null)
  const selectedPlaylistRef = useRef(null)

  useEffect(() => {
    if (globeEl.current) {
      // Auto-rotate when not interacting
      const controls = globeEl.current.controls()
      controls.autoRotate = !isInteracting
      controls.autoRotateSpeed = 0.5
      controls.enableZoom = true
      controls.minDistance = 180
      controls.maxDistance = 600

      // Initial smooth camera
      if (!selectedCountry) {
        globeEl.current.pointOfView({ altitude: 2.5 }, 0)
      }
    }
  }, [isInteracting])

  // Expose selectCountry method to parent via ref
  useImperativeHandle(ref, () => ({
    selectCountry: (countryCode) => {
      const country = countries.find(c => c.country_code === countryCode)
      if (country && globeEl.current) {
        setSelectedCountry(country)
        setIsInteracting(true)
        globeEl.current.pointOfView({
          lat: country.latitude,
          lng: country.longitude,
          altitude: 1.5
        }, 1200)
      }
    }
  }), [countries])

  // Select random country by default when countries load
  useEffect(() => {
    if (countries.length > 0 && !selectedCountry) {
      // Get countries with tracks
      const countriesWithTracks = countries.filter(c => c.tracks.length > 0)

      if (countriesWithTracks.length > 0) {
        // Pick random country
        const randomCountry = countriesWithTracks[Math.floor(Math.random() * countriesWithTracks.length)]

        if (randomCountry && globeEl.current) {
          setSelectedCountry(randomCountry)
          setIsInteracting(true)
          globeEl.current.pointOfView({
            lat: randomCountry.latitude,
            lng: randomCountry.longitude,
            altitude: 1.5
          }, 1200)
        }
      }
    }
  }, [countries])

  // Pause rotation when user interacts
  useEffect(() => {
    const handleUserInteraction = () => {
      setIsInteracting(true)

      // Clear previous timeout
      if (interactionTimeout.current) {
        clearTimeout(interactionTimeout.current)
      }

      // Resume after 3 seconds of no interaction
      interactionTimeout.current = setTimeout(() => {
        setIsInteracting(false)
      }, 3000)
    }

    window.addEventListener('mousemove', handleUserInteraction)
    window.addEventListener('mousedown', handleUserInteraction)
    window.addEventListener('wheel', handleUserInteraction)

    return () => {
      window.removeEventListener('mousemove', handleUserInteraction)
      window.removeEventListener('mousedown', handleUserInteraction)
      window.removeEventListener('wheel', handleUserInteraction)
      if (interactionTimeout.current) {
        clearTimeout(interactionTimeout.current)
      }
    }
  }, [])

  // Get vibrant color based on country/region
  const getCountryColor = (countryCode) => {
    const colorMap = {
      // Americas - Warm colors
      'US': '#ff6b6b', 'CA': '#ee5a6f', 'MX': '#ff8787', 'BR': '#ff9500',
      'AR': '#ffa94d', 'CL': '#ff922b', 'CO': '#fd7e14',

      // Europe - Cool blues and purples
      'GB': '#4c6ef5', 'DE': '#5c7cfa', 'FR': '#748ffc', 'ES': '#7950f2',
      'IT': '#9775fa', 'NL': '#845ef7', 'SE': '#7048e8', 'NO': '#6741d9',
      'PL': '#5f3dc4', 'CH': '#4c3eb7', 'BE': '#5c40a5', 'AT': '#6d28d9',
      'DK': '#7c3aed', 'FI': '#8b5cf6', 'GR': '#a78bfa', 'PT': '#c084fc',
      'IE': '#d8b4fe', 'CZ': '#9333ea', 'HU': '#a855f7', 'RO': '#c026d3',

      // Asia - Vibrant pinks and magentas
      'JP': '#ec4899', 'KR': '#f472b6', 'CN': '#f9a8d4', 'IN': '#e879f9',
      'TH': '#d946ef', 'SG': '#c026d3', 'MY': '#db2777', 'PH': '#be185d',
      'ID': '#9d174d', 'VN': '#831843',

      // Oceania - Cyan and teal
      'AU': '#06b6d4', 'NZ': '#0891b2',

      // Africa - Earth tones and oranges
      'ZA': '#f97316', 'EG': '#fb923c', 'NG': '#fdba74',

      // Middle East - Amber
      'TR': '#f59e0b', 'AE': '#fbbf24', 'SA': '#fcd34d'
    }

    return colorMap[countryCode] || '#64748b'
  }

  // Transform countries to fancy pin points
  const points = countries.map(country => ({
    lat: country.latitude,
    lng: country.longitude,
    size: country.tracks.length > 0 ? 1.2 : 0.6,
    color: country.tracks.length > 0 ? getCountryColor(country.country_code) : '#64748b',
    altitude: 0,
    country: country
  }))

  const handlePointClick = (point) => {
    setSelectedCountry(point.country)
    setIsInteracting(true)

    // Zoom to country
    if (globeEl.current) {
      globeEl.current.pointOfView({
        lat: point.lat,
        lng: point.lng,
        altitude: 1.5
      }, 1200)
    }
  }

  const handleGlobeClick = () => {
    // Click on globe (not a point) - close panel
    if (selectedCountry) {
      setSelectedCountry(null)
      if (globeEl.current) {
        globeEl.current.pointOfView({ altitude: 2.5 }, 1200)
      }
    }
  }

  const handleZoomIn = () => {
    if (globeEl.current) {
      const pov = globeEl.current.pointOfView()
      globeEl.current.pointOfView({ altitude: Math.max(pov.altitude - 0.5, 1.0) }, 500)
    }
  }

  const handleZoomOut = () => {
    if (globeEl.current) {
      const pov = globeEl.current.pointOfView()
      globeEl.current.pointOfView({ altitude: Math.min(pov.altitude + 0.5, 3.5) }, 500)
    }
  }

  const handleResetView = () => {
    if (globeEl.current) {
      globeEl.current.pointOfView({ altitude: 2.5 }, 1200)
      setSelectedCountry(null)
    }
  }

  const handleCountrySelect = (country) => {
    setSelectedCountry(country)
    setIsInteracting(true)
    // Clear playlist selection when selecting a country
    if (onSelectPlaylist) {
      onSelectPlaylist(null)
    }

    if (globeEl.current) {
      globeEl.current.pointOfView({
        lat: country.latitude,
        lng: country.longitude,
        altitude: 1.5
      }, 1200)
    }
  }

  const handlePlaylistSelect = (playlist) => {
    // Clear country selection when selecting a playlist
    setSelectedCountry(null)
    if (onSelectPlaylist) {
      onSelectPlaylist(playlist)
    }
    // Reset globe view
    if (globeEl.current) {
      globeEl.current.pointOfView({ altitude: 2.5 }, 1200)
    }
  }

  // Scroll to selected country in the list
  useEffect(() => {
    if (selectedCountry && selectedCountryRef.current) {
      selectedCountryRef.current.scrollIntoView({
        behavior: 'smooth',
        block: 'center'
      })
    }
  }, [selectedCountry])

  // Filter and sort countries by name
  const filteredCountries = countries.filter(country =>
    country.country_name.toLowerCase().includes(countrySearchTerm.toLowerCase())
  )
  const sortedCountries = [...filteredCountries].sort((a, b) =>
    a.country_name.localeCompare(b.country_name)
  )

  // Filter playlists by search term
  const filteredPlaylists = playlists?.filter(playlist =>
    playlist.name.toLowerCase().includes(playlistSearchTerm.toLowerCase())
  ) || []

  return (
    <div className="relative w-full h-full bg-black flex items-center justify-center">
      <div className="w-[600px] h-[600px]">
        <Globe
          ref={globeEl}
          globeImageUrl="https://unpkg.com/three-globe@2.31.1/example/img/earth-blue-marble.jpg"
          bumpImageUrl="https://unpkg.com/three-globe@2.31.1/example/img/earth-topology.png"
          backgroundImageUrl="//unpkg.com/three-globe/example/img/night-sky.png"
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-base font-semibold text-gray-900">Countries ({filteredCountries.length})</h3>
                <button
                  onClick={() => setShowCountryList(false)}
                  className="text-gray-500 hover:text-gray-900 transition-colors p-1"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              {/* Search Input */}
              <div className="relative">
                <input
                  type="text"
                  placeholder="Search countries..."
                  value={countrySearchTerm}
                  onChange={(e) => setCountrySearchTerm(e.target.value)}
                  className="w-full px-3 py-1.5 pl-8 text-sm bg-white/60 border border-white/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:bg-white/80 transition-all"
                />
                <svg className="absolute left-2.5 top-2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                {countrySearchTerm && (
                  <button
                    onClick={() => setCountrySearchTerm('')}
                    className="absolute right-2 top-1.5 text-gray-400 hover:text-gray-600"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                )}
              </div>
            </div>
            <div className="overflow-y-auto flex-1">
              {sortedCountries.map((country, index) => {
                const isSelected = selectedCountry?.country_code === country.country_code
                return (
                  <button
                    key={index}
                    ref={isSelected ? selectedCountryRef : null}
                    onClick={() => handleCountrySelect(country)}
                    className={`w-full px-3 py-2 text-left hover:bg-white/70 transition-all border-b border-white/30 ${
                      isSelected ? 'bg-white/80' : ''
                    }`}
                  >
                    <div className="flex items-center gap-2">
                      <span className="text-xl flex-shrink-0">{country.flag}</span>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-gray-900 truncate">{country.country_name}</p>
                        <p className="text-xs text-gray-600">{country.tracks.length} tracks</p>
                      </div>
                    </div>
                  </button>
                )
              })}
            </div>
          </div>
        )}

        {/* Playlists Section */}
        {showPlaylistsSection && playlists && playlists.length > 0 && (
          <div className="bg-purple-50/80 backdrop-blur-2xl backdrop-saturate-150 rounded-xl border border-purple-200/40 shadow-2xl overflow-hidden flex flex-col max-h-[42vh]">
            <div className="px-3 py-2 border-b border-purple-200/50 bg-purple-100/50">
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-2">
                  <svg className="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z" />
                  </svg>
                  <h3 className="text-base font-semibold text-purple-900">Playlists ({filteredPlaylists.length})</h3>
                </div>
                <button
                  onClick={() => setShowPlaylistsSection(false)}
                  className="text-purple-500 hover:text-purple-900 transition-colors p-1"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              {/* Search Input */}
              <div className="relative">
                <input
                  type="text"
                  placeholder="Search playlists..."
                  value={playlistSearchTerm}
                  onChange={(e) => setPlaylistSearchTerm(e.target.value)}
                  className="w-full px-3 py-1.5 pl-8 text-sm bg-white/60 border border-purple-200/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 focus:bg-white/80 transition-all"
                />
                <svg className="absolute left-2.5 top-2 w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                {playlistSearchTerm && (
                  <button
                    onClick={() => setPlaylistSearchTerm('')}
                    className="absolute right-2 top-1.5 text-purple-400 hover:text-purple-600"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                )}
              </div>
            </div>
            <div className="overflow-y-auto flex-1">
              {filteredPlaylists.map((playlist, index) => {
                const isSelected = selectedPlaylist?.id === playlist.id
                return (
                  <div
                    key={playlist.id}
                    ref={isSelected ? selectedPlaylistRef : null}
                    className="group relative"
                  >
                    <button
                      onClick={() => handlePlaylistSelect(playlist)}
                      className={`w-full px-3 py-2 text-left hover:bg-purple-100/80 transition-all border-b border-purple-200/30 ${
                        isSelected ? 'bg-purple-100/90' : ''
                      }`}
                    >
                      <div className="flex items-center justify-between gap-2">
                        <div className="flex items-center gap-2 min-w-0 flex-1">
                          <span className="text-lg flex-shrink-0">ðŸŽµ</span>
                          <div className="min-w-0 flex-1">
                            <div className="text-sm text-purple-900 font-medium truncate">{playlist.name}</div>
                            <div className="text-xs text-purple-600">{playlist.tracks.length} tracks</div>
                          </div>
                        </div>
                      </div>
                    </button>
                    <button
                      onClick={() => onRemovePlaylist && onRemovePlaylist(playlist.id)}
                      className="absolute top-2 right-2 p-1.5 bg-red-500/80 hover:bg-red-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                      title="Remove playlist"
                    >
                      <svg className="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                )
              })}
            </div>
          </div>
        )}
      </div>

      {/* Center Column - Globe & Controls */}
      <div className="flex flex-col items-center gap-3">
        <div className="w-[600px] h-[600px]">
          <Globe
            ref={globeEl}
            globeImageUrl="https://unpkg.com/three-globe@2.31.1/example/img/earth-blue-marble.jpg"
            bumpImageUrl="https://unpkg.com/three-globe@2.31.1/example/img/earth-topology.png"
            backgroundImageUrl="//unpkg.com/three-globe/example/img/night-sky.png"

        pointsData={points}
        pointAltitude="altitude"
        pointRadius="size"
        pointColor="color"
        pointResolution={12}
        pointsMerge={false}
        onPointClick={handlePointClick}

        htmlElementsData={points}
        htmlElement={d => {
          const el = document.createElement('div')
          el.style.cssText = `
            width: 24px;
            height: 24px;
            background: ${d.color};
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            transition: transform 0.2s;
          `
          el.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 16 16" fill="white" xmlns="http://www.w3.org/2000/svg" style="display: block;">
              <path d="M12 0C12.5523 0 13 0.447715 13 1V10C13 11.6569 11.6569 13 10 13C8.34315 13 7 11.6569 7 10C7 8.34315 8.34315 7 10 7C10.3506 7 10.6872 7.06015 11 7.17071V4.618L6 5.618V12C6 13.6569 4.65685 15 3 15C1.34315 15 0 13.6569 0 12C0 10.3431 1.34315 9 3 9C3.35064 9 3.68719 9.06015 4 9.17071V5C4 4.57037 4.28365 4.19121 4.69742 4.06531L11.6974 2.06531C12.4148 1.85867 13 2.47364 13 3.2V0C13 0.447715 12.5523 0 12 0Z"/>
            </svg>
          `
          el.addEventListener('mouseenter', () => {
            el.style.transform = 'scale(1.3)'
          })
          el.addEventListener('mouseleave', () => {
            el.style.transform = 'scale(1)'
          })
          el.addEventListener('click', () => handlePointClick(d))
          return el
        }}
        htmlTransitionDuration={0}

        onGlobeClick={handleGlobeClick}

        ringsData={points.filter(p => p.country.tracks.length > 0)}
        ringColor={d => d.color}
        ringMaxRadius={1.5}
        ringPropagationSpeed={0.35}
        ringRepeatPeriod={2000}

        atmosphereColor="#38bdf8"
        atmosphereAltitude={0.20}

        width={600}
        height={600}

        enablePointerInteraction={true}
          />
        </div>

        {/* Controls below globe */}
        <div className="flex space-x-2">
          {/* Zoom Controls */}
          <div className="bg-slate-900/80 backdrop-blur-md rounded-md border border-slate-700/50 shadow-xl overflow-hidden flex">
            <button
              onClick={handleZoomIn}
              className="w-10 h-10 flex items-center justify-center text-slate-300 hover:text-white hover:bg-slate-800/50 transition-all border-r border-slate-700/50"
              title="Zoom In"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
              </svg>
            </button>
            <button
              onClick={handleZoomOut}
              className="w-10 h-10 flex items-center justify-center text-slate-300 hover:text-white hover:bg-slate-800/50 transition-all border-r border-slate-700/50"
              title="Zoom Out"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 12H4" />
              </svg>
            </button>
            <button
              onClick={handleResetView}
              className="w-10 h-10 flex items-center justify-center text-slate-300 hover:text-white hover:bg-slate-800/50 transition-all"
              title="Reset View"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            </button>
          </div>

          {/* Country List Toggle */}
          <div className="bg-slate-900/80 backdrop-blur-md rounded-md border border-slate-700/50 shadow-xl overflow-hidden">
            <button
              onClick={() => setShowCountryList(!showCountryList)}
              className="w-10 h-10 flex items-center justify-center text-slate-300 hover:text-white hover:bg-slate-800/50 transition-all"
              title="Toggle Country List"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      {/* Country List Panel - Left of globe */}
      {showCountryList && (
        <div className="absolute top-[8%] left-[calc(50%-608px)] w-72 max-h-[42vh] bg-white/70 backdrop-blur-2xl backdrop-saturate-150 rounded-xl border border-white/30 shadow-2xl overflow-hidden flex flex-col">
          <div className="px-3 py-2 border-b border-white/40 bg-white/40">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-base font-semibold text-gray-900">Countries ({filteredCountries.length})</h3>
              <button
                onClick={() => setShowCountryList(false)}
                className="text-gray-500 hover:text-gray-900 transition-colors p-1"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            {/* Search Input */}
            <div className="relative">
              <input
                type="text"
                placeholder="Search countries..."
                value={countrySearchTerm}
                onChange={(e) => setCountrySearchTerm(e.target.value)}
                className="w-full px-3 py-1.5 pl-8 text-sm bg-white/60 border border-white/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:bg-white/80 transition-all"
              />
              <svg className="absolute left-2.5 top-2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              {countrySearchTerm && (
                <button
                  onClick={() => setCountrySearchTerm('')}
                  className="absolute right-2 top-1.5 text-gray-400 hover:text-gray-600"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              )}
            </div>
          </div>
          <div className="overflow-y-auto max-h-[calc(42vh-48px)]">
            {sortedCountries.map((country, index) => {
              const isSelected = selectedCountry?.country_code === country.country_code
              return (
                <button
                  key={index}
                  ref={isSelected ? selectedCountryRef : null}
                  onClick={() => handleCountrySelect(country)}
                  className={`w-full px-3 py-2 text-left hover:bg-white/70 transition-all border-b border-white/30 ${
                    isSelected ? 'bg-white/80' : ''
                  }`}
                >
                  <div className="flex items-center justify-between gap-2">
                    <div className="flex items-center gap-2 min-w-0">
                      <span className="text-xl flex-shrink-0">{country.flag}</span>
                      <span className="text-sm text-gray-900 font-medium truncate">{country.country_name}</span>
                    </div>
                    <span className={`text-xs px-1.5 py-0.5 rounded flex-shrink-0 ${
                      country.tracks.length > 0
                        ? 'bg-blue-500/90 text-white'
                        : 'bg-gray-300/70 text-gray-700'
                    }`}>
                      {country.tracks.length}
                    </span>
                  </div>
                </button>
              )
            })}
          </div>
        </div>
      )}

      {/* Playlists Section - Left of globe, below countries */}
      {showPlaylistsSection && playlists && playlists.length > 0 && (
        <div className="absolute bottom-[12%] left-[calc(50%-608px)] w-72 max-h-[42vh] bg-purple-50/80 backdrop-blur-2xl backdrop-saturate-150 rounded-xl border border-purple-200/40 shadow-2xl overflow-hidden flex flex-col">
          <div className="px-3 py-2 border-b border-purple-200/50 bg-purple-100/50">
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2">
                <svg className="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z" />
                </svg>
                <h3 className="text-base font-semibold text-purple-900">Playlists ({filteredPlaylists.length})</h3>
              </div>
              <button
                onClick={() => setShowPlaylistsSection(false)}
                className="text-purple-500 hover:text-purple-900 transition-colors p-1"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            {/* Search Input */}
            <div className="relative">
              <input
                type="text"
                placeholder="Search playlists..."
                value={playlistSearchTerm}
                onChange={(e) => setPlaylistSearchTerm(e.target.value)}
                className="w-full px-3 py-1.5 pl-8 text-sm bg-white/60 border border-purple-200/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 focus:bg-white/80 transition-all"
              />
              <svg className="absolute left-2.5 top-2 w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              {playlistSearchTerm && (
                <button
                  onClick={() => setPlaylistSearchTerm('')}
                  className="absolute right-2 top-1.5 text-purple-400 hover:text-purple-600"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              )}
            </div>
          </div>
          <div className="overflow-y-auto max-h-[calc(42vh-48px)]">
            {filteredPlaylists.map((playlist, index) => {
              const isSelected = selectedPlaylist?.id === playlist.id
              return (
                <div
                  key={playlist.id}
                  ref={isSelected ? selectedPlaylistRef : null}
                  className="group relative"
                >
                  <button
                    onClick={() => handlePlaylistSelect(playlist)}
                    className={`w-full px-3 py-2 text-left hover:bg-purple-100/80 transition-all border-b border-purple-200/30 ${
                      isSelected ? 'bg-purple-100/90' : ''
                    }`}
                  >
                    <div className="flex items-center justify-between gap-2">
                      <div className="flex items-center gap-2 min-w-0 flex-1">
                        <span className="text-lg flex-shrink-0">ðŸŽµ</span>
                        <div className="min-w-0 flex-1">
                          <div className="text-sm text-purple-900 font-medium truncate">{playlist.name}</div>
                          <div className="text-xs text-purple-600">{playlist.tracks.length} tracks</div>
                        </div>
                      </div>
                      <span className="text-xs px-1.5 py-0.5 rounded flex-shrink-0 bg-purple-500/90 text-white">
                        {playlist.tracks.length}
                      </span>
                    </div>
                  </button>
                  {/* Delete button */}
                  <button
                    onClick={(e) => {
                      e.stopPropagation()
                      onRemovePlaylist && onRemovePlaylist(playlist.id)
                    }}
                    className="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-red-100 rounded"
                    title="Remove playlist"
                  >
                    <svg className="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              )
            })}
          </div>
        </div>
      )}


      {/* Track List Panel for Country - Right of globe */}
      {selectedCountry && !selectedPlaylist && (
        <div className="absolute top-1/2 -translate-y-1/2 left-[calc(50%+320px)] w-80 max-h-[calc(100vh-120px)] mb-[100px] bg-white/70 backdrop-blur-2xl backdrop-saturate-150 rounded-xl border border-white/30 shadow-2xl overflow-hidden flex flex-col">
          <div className="flex items-center justify-between px-3 py-2 border-b border-white/40 bg-white/40">
            <div className="flex items-center gap-2">
              <span className="text-xl">{selectedCountry.flag}</span>
              <h3 className="text-base font-semibold text-gray-900">
                {selectedCountry.country_name}
              </h3>
            </div>
            <button
              onClick={() => {
                setSelectedCountry(null)
                if (globeEl.current) {
                  globeEl.current.pointOfView({ altitude: 2.5 }, 1200)
                }
              }}
              className="text-gray-500 hover:text-gray-900 transition-colors p-1"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div className="flex-1 overflow-hidden">
            <TrackList
              country={selectedCountry}
              trackFilter={trackFilter}
              currentTrack={currentTrack}
              onPlaySong={onPlaySong}
            />
          </div>
        </div>
      )}

      {/* Track List Panel for Playlist - Right of globe */}
      {selectedPlaylist && (
        <div className="absolute top-1/2 -translate-y-1/2 left-[calc(50%+320px)] w-80 max-h-[calc(100vh-120px)] mb-[100px] bg-purple-50/80 backdrop-blur-2xl backdrop-saturate-150 rounded-xl border border-purple-200/40 shadow-2xl overflow-hidden flex flex-col">
          <div className="flex items-center justify-between px-3 py-2 border-b border-purple-200/50 bg-purple-100/50">
            <div className="flex items-center gap-2">
              <span className="text-xl">ðŸŽµ</span>
              <h3 className="text-base font-semibold text-purple-900">
                {selectedPlaylist.name}
              </h3>
            </div>
            <button
              onClick={() => {
                onSelectPlaylist && onSelectPlaylist(null)
              }}
              className="text-purple-500 hover:text-purple-900 transition-colors p-1"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div className="flex-1 overflow-hidden">
            <TrackList
              playlist={selectedPlaylist}
              trackFilter={trackFilter}
              currentTrack={currentTrack}
              onPlaySong={onPlaySong}
            />
          </div>
        </div>
      )}
    </div>
  )
})

GlobeMap.displayName = 'GlobeMap'

export default GlobeMap
